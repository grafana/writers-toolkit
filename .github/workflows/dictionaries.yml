name: Update generated Vale files on a branch

permissions: {}

on:
  workflow_dispatch:
  issue_comment:
    types: [created]

jobs:
  main:
    if: |
      github.repository == 'grafana/writers-toolkit' && (
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'issue_comment' &&
         github.event.issue.pull_request &&
         contains(github.event.comment.body, '/regenerate-dictionaries'))
      )
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Check user permission
        if: github.event_name == 'issue_comment'
        id: check-permission
        env:
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
          USERNAME: ${{ github.event.comment.user.login }}
        run: |
          permission=$(gh api "repos/${REPOSITORY}/collaborators/${USERNAME}/permission" --jq .permission)
          if [[ "$permission" == "admin" || "$permission" == "write" ]]; then
            echo "has_permission=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_permission=false" >> "$GITHUB_OUTPUT"
          fi
        shell: bash
      - name: React with thumbs down if no permission
        if: github.event_name == 'issue_comment' && steps.check-permission.outputs.has_permission == 'false'
        env:
          COMMENT_ID: ${{ github.event.comment.id }}
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
        run: |
          gh api \
            --method POST \
            "repos/${REPOSITORY}/issues/comments/${COMMENT_ID}/reactions" \
            -f content='-1'
          echo "::error::User does not have write access to this repository"
          exit 1
        shell: bash
      - name: React to comment
        if: github.event_name == 'issue_comment' && steps.check-permission.outputs.has_permission == 'true'
        env:
          COMMENT_ID: ${{ github.event.comment.id }}
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
        run: |
          gh api \
            --method POST \
            "repos/${REPOSITORY}/issues/comments/${COMMENT_ID}/reactions" \
            -f content='eyes'
        shell: bash
      - name: Get PR branch
        if: github.event_name == 'issue_comment' && steps.check-permission.outputs.has_permission == 'true'
        id: pr-branch
        env:
          GH_TOKEN: ${{ github.token }}
          PR: ${{ github.event.issue.number }}
          REPOSITORY: ${{ github.repository }}
        run: |
          info="$(gh api "repos/${REPOSITORY}/pulls/${PR}")"
          echo "ref=$(echo "${info}" | jq -r .head.ref)" >> "$GITHUB_OUTPUT"
          echo "repo=$(echo "${info}" | jq -r .head.repo.full_name)" >> "$GITHUB_OUTPUT"
          echo "is_fork=$(echo "${info}" | jq -r '.head.repo.full_name != .base.repo.full_name')" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: Block fork PRs
        if: github.event_name == 'issue_comment' && steps.pr-branch.outputs.is_fork == 'true'
        env:
          COMMENT_ID: ${{ github.event.comment.id }}
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
        run: |
          gh api \
            --method POST \
            "repos/${REPOSITORY}/issues/comments/${COMMENT_ID}/reactions" \
            -f content='confused'
          gh pr comment ${{ github.event.issue.number }} \
            --repo "${REPOSITORY}" \
            --body "‚ùå This command cannot be run on PRs from forks for security reasons. Create a branch in the main repository instead."
          echo "::error::Cannot run on fork-based PRs for security reasons"
          exit 1
        shell: bash
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        if: github.event_name == 'workflow_dispatch'
        with:
          persist-credentials: false
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        if: github.event_name == 'issue_comment' && steps.check-permission.outputs.has_permission == 'true' && steps.pr-branch.outputs.is_fork == 'false'
        with:
          repository: ${{ steps.pr-branch.outputs.repo }}
          ref: ${{ steps.pr-branch.outputs.ref }}
          persist-credentials: false
      - id: get-secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@97c6f45f01d4bca8a3b1acfe397113ce88858a81 # get-vault-secrets-v1.0.1
        with:
          repo_secrets: |
            DOCS_PLATFORM_TEAM_APP_ID=docs-platform-team:app-id
            DOCS_PLATFORM_TEAM_PRIVATE_KEY=docs-platform-team:key
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ env.DOCS_PLATFORM_TEAM_APP_ID }}
          owner: grafana
          private-key: ${{ env.DOCS_PLATFORM_TEAM_PRIVATE_KEY }}
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: package.json
      - run: npm install --no-save prettier
      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: tools/go.mod
      - run: go install github.com/google/go-jsonnet/cmd/jsonnet@latest
      - working-directory: vale
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euf -o pipefail

          if [[ -n "${RUNNER_DEBUG+x}" ]]; then
            set -x
          fi

          # commit adds and commits the updated files as the Grafanabot GitHub user.
          function commit {
            git add .
            git config --local user.email bot@grafana.com
            git config --local user.name grafanabot
            git commit --message 'Update generated Vale files'
          }

          # It's fine to run this even though it depends on committed code because only repository collaborators with write access can trigger the workflow (Grafana Labs employees).
          make -B all

          if ! git diff --exit-code; then
            commit
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/grafana/writers-toolkit"
            git push origin
          fi
        shell: bash
