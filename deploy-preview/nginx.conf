worker_processes 5;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;
worker_rlimit_nofile 8192;

events {
  worker_connections 4096;
}

http {

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
  ssl_prefer_server_ciphers on;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  gzip on;

  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

  server {
    absolute_redirect off;

    listen 80;

    add_header "X-UA-Compatible" "IE=Edge,chrome=1";
    add_header "Strict-Transport-Security" "max-age=31536000; includeSubDomains; preload";
    add_header "Referrer-Policy" "origin-when-cross-origin";

    # add_header "Content-Security-Policy-Report-Only" "object-src 'none'; script-src 'report-sample' 'self' 'unsafe-eval' 'unsafe-inline' 'sha256-HNwGiG3xFKuDX/zKYWVB/Lykh85DfcqKEJgCwk+t9gM=' https://js.intercomcdn.com https://widget.intercom.io/widget/ https://go2.grafana.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://x.clearbitjs.com https://app.clearbit.com https://munchkin.marketo.net https://connect.facebook.net https://snap.licdn.com https://www.google-analytics.com/ https://px.ads.linkedin.com https://www.linkedin.com https://fresnel.vimeocdn.com https://f.vimeocdn.com https://vimeo.com https://player.vimeo.com https://platform.twitter.com https://syndication.twitter.com https://api.twitter.com https://twitter.com https://static.hotjar.com https://in.hotjar.com https://script.hotjar.com https://www.googletagmanager.com/gtag/ *.googleadservices.com https://googleads.g.doubleclick.net/pagead/ https://static.doubleclick.net https://www.youtube.com https://www.eventbrite.com http://rsdk.grafana.com http://rsdk2.grafana.com https://heypal.chat https://www.heypal.chat https://pal-api-production.up.railway.app https://faro-collector-prod-us-central-0.grafana.net https://*.fullstory.com https://rsi.grafana.com; report-uri /api/csp-reports";
    add_header "Content-Security-Policy" "object-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://go2.grafana.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://x.clearbitjs.com https://app.clearbit.com https://munchkin.marketo.net https://connect.facebook.net https://snap.licdn.com https://www.google-analytics.com/ https://px.ads.linkedin.com https://www.linkedin.com https://fresnel.vimeocdn.com https://f.vimeocdn.com https://vimeo.com https://player.vimeo.com https://platform.twitter.com https://syndication.twitter.com https://api.twitter.com https://twitter.com https://static.hotjar.com https://in.hotjar.com https://script.hotjar.com https://www.googletagmanager.com/gtag/ *.googleadservices.com https://googleads.g.doubleclick.net/pagead/ https://static.doubleclick.net https://www.youtube.com https://www.eventbrite.com http://rsdk.grafana.com http://rsdk2.grafana.com https://heypal.chat https://www.heypal.chat https://pal-api-production.up.railway.app https://faro-collector-prod-us-central-0.grafana.net https://*.fullstory.com https://rsi.grafana.com https://cdn.mouseflow.com https://widget.intercom.io https://js.intercomcdn.com https://*.qualtrics.com https://js.zi-scripts.com https://tags.clickagy.com https://widget.kapa.ai https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/";

    add_header Cache-Control "public, max-age=0, must-revalidate";
    add_header X-Frame-Options "DENY";

    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';

    error_page 404 /404.html;
    error_page 403 /404.html; # show 404 instead of 403 when directory exists but index.html does not
    location = /404.html {
      ssi on;
      ssi_last_modified on;
      root /usr/share/nginx/dist/;
      internal;
    }

    # move assets to a different layer to prevent docker cache invalidation
    # https://regex101.com/r/M7HrFY/1
    location ~* ^/static/(app.min.css|app.css.map|shared.min.css|shared.css.map|.*.json|.*.html|.*.js|lastmod.csv)$ {
      alias /usr/share/nginx/assets/$1;
    }

    location / {
      ssi on;
      ssi_last_modified on;
      alias /usr/share/nginx/dist/;
    }

    location /static {
      proxy_pass https://grafana.com/static;
    }

    location /media {
      proxy_pass https://grafana.com/media;
    }

    location /api {
      proxy_pass https://grafana.com/api;
    }

    location ~ ^/connect(.*)$ {

      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

      proxy_ssl_server_name on;
      resolver          8.8.8.8 8.8.4.4 ipv6=off;
      resolver_timeout  5s;
      set $faro "faro-collector-prod-us-central-0.grafana.net";

      proxy_pass https://$faro/collect$1;
    }


    location /healthz {
      return 200 'ok';
      add_header Content-Type text/plain;
    }
  }
}
